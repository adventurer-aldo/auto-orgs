class Sunny

  @fibbs = {
  1 => ["twunks", "butter", "bagels", "hot dogs", "lemonade"],
  2 => ["ghost named Idan", "overdose on bath salts", "demon", "evil spirit", "discord Admin", "Ouija board"],
  3 => ["the skin of fallen enemies", "artificial intelligence", "hair", "Wood", "recycled video game consoles", "human hair"],
  4 => ["100,000", "35,000", "50,000", "6,700", "65,160", "56,000"],
  5 => ["the dumbest", "alien", "attractive", "left-handed children", "ugly"],
  6 => ["unclothed", "bathroom", "death", "partial nudity", "shower scene", "toilet flushing"],
  7 => ["Social Credit points", "birds", "horses", "ducks", "donkeys", "geese"],
  8 => ["sit alone in the shower thinking", "sleep", "traumatized", "goon", "watch a baby cry", "listen to music"],
  9 => ["DNA", "at home technology", "braind", "a hot tub", "bugs", "cockroaches"],
  10 => ["Fallen Ice King", "Laughing Man", "Ghostbusters", "Bad Guy", "Panty Snatcher", "Tickler"],
  11 => ["Breaking and entering", "absinthe", "pickles", "drugs", "magic mushrooms", "heroin"],
  12 => ["Celiochromatysis syrup", "iced tea", "sunscreen", "vaseline", "flavored poop"],
  13 => ["bass clef", "phone", "perfect pitch", "Baby Shark", "G6", "baby shower"]
}

  @solved_fibbs = {
  1 => [
    { author: "Hasegawa", value: "twunks" },
    { author: "Hayden", value: "butter" },
    { author: "Hunjax", value: "bagels" },
    { author: "Iromi", value: "lemonade" },
    { author: "Jayden", value: "hot dogs" }
  ],
  2 => [
    { author: "Hasegawa", value: "ghost named Idan" },
    { author: "Hayden", value: "overdose on bath salts" },
    { author: "Hunjax", value: "demon" },
    { author: "Iromi", value: "discord Admin" },
    { author: "Jayden", value: "evil spirit" }
  ],
  3 => [
    { author: "Hasegawa", value: "the skin of fallen enemies" },
    { author: "Hayden", value: "recycled video game consoles" },
    { author: "Hunjax", value: "hair" },
    { author: "Iromi", value: "wood" },
    { author: "Jayden", value: "artificial intelligence" }
  ],
  4 => [
    { author: "Hasegawa", value: "100,000" },
    { author: "Hayden", value: "65,160" },
    { author: "Hunjax", value: "50,000" },
    { author: "Iromi", value: "6,700" },
    { author: "Jayden", value: "35,000" }
  ],
  5 => [
    { author: "Hasegawa", value: "the dumbest" },
    { author: "Hayden", value: "left-handed children" },
    { author: "Hunjax", value: "ugly" },
    { author: "Iromi", value: "alien" },
    { author: "Jayden", value: "attractive" }
  ],
  6 => [
    { author: "Hasegawa", value: "unclothed" },
    { author: "Hayden", value: "partial nudity" },
    { author: "Hunjax", value: "shower scene" },
    { author: "Iromi", value: "bathroom" },
    { author: "Jayden", value: "death" }
  ],
  7 => [
    { author: "Hasegawa", value: "Social Credit points" },
    { author: "Hayden", value: "donkeys" },
    { author: "Hunjax", value: "birds" },
    { author: "Iromi", value: "ducks" },
    { author: "Jayden", value: "horses" }
  ],
  8 => [
    { author: "Hasegawa", value: "sit alone in the shower thinking" },
    { author: "Hayden", value: "watch a baby cry" },
    { author: "Hunjax", value: "sleep" },
    { author: "Iromi", value: "goon" },
    { author: "Jayden", value: "traumatized" }
  ],
  9 => [
    { author: "Hasegawa", value: "DNA" },
    { author: "Hayden", value: "a hot tub" },
    { author: "Hunjax", value: "bugs" },
    { author: "Iromi", value: "braind" },
    { author: "Jayden", value: "at home technology" }
  ],
  10 => [
    { author: "Hasegawa", value: "Fallen Ice King" },
    { author: "Hayden", value: "Panty Snatcher" },
    { author: "Hunjax", value: "Bad Guy" },
    { author: "Iromi", value: "Ghostbusters" },
    { author: "Jayden", value: "Laughing Man" }
  ],
  11 => [
    { author: "Hasegawa", value: "Breaking and entering" },
    { author: "Hayden", value: "absinthe" },
    { author: "Hunjax", value: "magic mushrooms" },
    { author: "Iromi", value: "pickles" },
    { author: "Jayden", value: "drugs" }
  ],
  12 => [
    { author: "Hasegawa", value: "Celiochromatysis syrup" },
    { author: "Hayden", value: "Vaseline" },
    { author: "Hunjax", value: "flavored poop" },
    { author: "Iromi", value: "Iced Tea" },
    { author: "Jayden", value: "sunscreen" }
  ],
  13 => [
    { author: "Hasegawa", value: "bass clef" },
    { author: "Hayden", value: "G6" },
    { author: "Hunjax", value: "Baby Shark" },
    { author: "Iromi", value: "phone" },
    { author: "Jayden", value: "perfect pitch" }
  ]
}

  @questions = [
  "Ben and Jerry only started making ice cream because it was too expensive to make ï¹ï¹ï¹ï¹ï¹ï¹.",
  "In 2012, a teenager from Weslaco, Texas claimed the reason he stabbed his friend was because a ï¹ï¹ï¹ï¹ï¹ï¹ made him do it.",
  "A science student in Nepal has created an innovative solar panel that is far cheaper to make than a traditional solar panel, because it's made with ï¹ï¹ï¹ï¹ï¹ï¹.",
  "According to Forbes, the average income for an â€œice cream tasterâ€ is $ï¹ï¹ï¹ï¹ï¹ï¹ a year.",
  "According to a University of Jena study, the people who have the most memorable faces are ï¹ï¹ï¹ï¹ï¹ï¹ people.",
  "*Psycho* was the first American movie to show a ï¹ï¹ï¹ï¹ï¹ï¹.",
  "Instead of having guard dogs, police in rural parts of China's Xinjiang Province use ï¹ï¹ï¹ï¹ï¹ï¹.",
  "According to a University of Barcelona study, surprisingly, 5% of people have absolutely no emotional response when they ï¹ï¹ï¹ï¹ï¹ï¹.",
  "The Backyard Brains company sells a device that lets you control ï¹ï¹ï¹ï¹ï¹ï¹ with your mobile phone.",
  "During the mid to late-nineties, the town of Glastonbury was on a manhunt for the odd house intruder known as â€œThe ï¹ï¹ï¹ï¹ï¹ï¹.â€",
  "For a story he was reporting on in 1955, Dan Rather tried ï¹ï¹ï¹ï¹ï¹ï¹ for the first time.",
  "Although gross, chemist Sir Robert Cheseborough claimed he ate a spoonful of his invention, ï¹ï¹ï¹ï¹ï¹ï¹, every day.",
  "CELEBRITY TWEET! 12:44 AM - 10 Dec 2013 @SimonCowell Tweeted: â€œStill not sure what a ï¹ï¹ï¹ï¹ï¹ï¹ is.â€"
]


  @id_map = {
    "FirstQuestion"      => 1,
    "SecondQuestion"     => 2,
    "ThirdQuestion"      => 3,
    "FourthQuestion"     => 4,
    "FifthQuestion"      => 5,
    "SixthQuestion"      => 6,
    "SeventhQuestion"    => 7,
    "EighthQuestion"     => 8,
    "NinthQuestion"      => 9,
    "TenthQuestion"      => 10,
    "EleventhQuestion"   => 11,
    "TwelfthQuestion"    => 12,
    "ThirteenthQuestion" => 13
  }

  @id_map.keys.each do |key|
    BOT.string_select(custom_id: key) do |event|
      event.defer_update

      break unless event.user.id.player?
      player = Player.find_by(user_id: event.user.id, season_id: Setting.last.season)
      q_no = @id_map[key]
      BOT.channel(HOST_CHAT).send_message("**#{player.name}** chose **#{event.values.first}** for Question No. #{q_no}")
      BOT.channel(player.submissions).send_message("You chose **#{event.values.first}** for Question No. #{q_no}")
      Challenges::Fibbage.find_or_create_by(player_id: player.id, question_no: q_no)
                        .update(value: event.values.first)
      BOT.channel(player.submissions).send_embed do |embed|
        embed.title = "List of your answers"
        embed.description = player.fibbages.order(question_no: :asc).map { |fibb| "**#{fibb.question_no}.** #{@questions[fibb.question_no - 1]}\n**Answer:** #{fibb.value}" }.join("\n\n")
        embed.color = event.user.on(ALVIVOR_ID).color
      end

    end
  end

  BOT.command :fibb do |event|
    break unless event.user.id.host?
    chan = event.channel
    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "FirstQuestion", options: @fibbs[1].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**1st Question:**\nBen and Jerry only started making ice cream because it was too expensive to make ï¹ï¹ï¹ï¹ï¹ï¹.", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "SecondQuestion", options: @fibbs[2].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**2nd Question:**\nIn 2012, a teenager from Weslaco, Texas claimed the reason he stabbed his friend was because a ï¹ï¹ï¹ï¹ï¹ï¹ made him do it.", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "ThirdQuestion", options: @fibbs[3].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**3rd Question:**\nA science student in Nepal has created an innovative solar panel that is far cheaper to make than a traditional solar panel, because itâ€™s made with ï¹ï¹ï¹ï¹ï¹ï¹.", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "FourthQuestion", options: @fibbs[4].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**4th Question:**\nAccording to Forbes, the average income for an â€œice cream tasterâ€ is $ï¹ï¹ï¹ï¹ï¹ï¹ a year.", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "FifthQuestion", options: @fibbs[5].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**5th Question:**\nAccording to a University of Jena study, the people who have the most memorable faces are ï¹ï¹ï¹ï¹ï¹ï¹ people.", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "SixthQuestion", options: @fibbs[6].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**6th Question:**\n*Psycho* was the first American movie to show a ï¹ï¹ï¹ï¹ï¹ï¹.", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "SeventhQuestion", options: @fibbs[7].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**7th Question:**\nInstead of having guard dogs, police in rural parts of Chinaâ€™s Xinjiang Province use ï¹ï¹ï¹ï¹ï¹ï¹.", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "EighthQuestion", options: @fibbs[8].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**8th Question:**\nAccording to a University of Barcelona study, surprisingly, 5% of people have absolutely no emotional response when they ï¹ï¹ï¹ï¹ï¹ï¹.", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "NinthQuestion", options: @fibbs[9].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**9th Question:**\nThe Backyard Brains company sells a device that lets you control ï¹ï¹ï¹ï¹ï¹ï¹ with your mobile phone.", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "TenthQuestion", options: @fibbs[10].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**10th Question:**\nDuring the mid to late-nineties, the town of Glastonbury was on a manhunt for the odd house intruder known as â€œThe ï¹ï¹ï¹ï¹ï¹ï¹.â€", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "EleventhQuestion", options: @fibbs[11].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**11th Question:**\nFor a story he was reporting on in 1955, Dan Rather tried ï¹ï¹ï¹ï¹ï¹ï¹ for the first time.", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "TwelfthQuestion", options: @fibbs[12].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**12th Question:**\nAlthough gross, chemist Sir Robert Cheseborough claimed he ate a spoonful of his invention, ï¹ï¹ï¹ï¹ï¹ï¹, every day.", false, nil, nil, nil, nil, view)

    view = Discordrb::Webhooks::View.new
    view.row do |row|
      row.string_select(custom_id: "ThirteenthQuestion", options: @fibbs[13].map { |fibb| { label: fibb, value: fibb } })
    end
    chan.send_message("**13th Question:**\nCELEBRITY TWEET! 12:44 AM - 10 Dec 2013 @SimonCowell Tweeted: â€œStill not sure what a ï¹ï¹ï¹ï¹ï¹ï¹ is.â€", false, nil, nil, nil, nil, view)
  end
  def self.delayed_respond(event, msg)
    event.channel.start_typing
    sleep([msg.length * 0.05, 1].max) # at least 1 second, longer if msg is longer
    event.respond msg
  end
  BOT.command :fibbtry do |event|
  # real answers
  real_answers = {
    1 => "bagels", 2 => "ouija board", 3 => "human hair", 4 => "56000",
    5 => "ugly", 6 => "toilet flushing", 7 => "geese", 8 => "listen to music",
    9 => "cockroaches", 10 => "Tickler", 11 => "heroin", 12 => "vaseline",
    13 => "baby shower"
  }

  # scoreboard
  points = Hash.new(0)

  # helper for typing + response

  (1..13).each do |q_no|
    tries = Challenges::Fibbage.where(question_no: q_no).to_a

    delayed_respond(event, ".")
    delayed_respond(event, "**Question #{q_no}:**")
    delayed_respond(event, "ğŸ‘‰ #{@questions[q_no - 1]}")

    if tries.empty?
      delayed_respond(event, "No submissions or guesses for this question.")
      next
    end

    grouped = tries.group_by { |t| t.value.to_s.strip.downcase }
    correct_key = real_answers[q_no].downcase
    ordered = grouped.partition { |val, _| val != correct_key }
    fibs = ordered[0]
    correct = ordered[1]

    (fibs + correct).each do |val_key, attempts|
      display_value = attempts.first.value.to_s
      names = attempts.map { |t| t.player.name }.join(", ")

      delayed_respond(event, ".")
      delayed_respond(event, "#{attempts.size} person#{'s' if attempts.size > 1} said \"#{display_value}\" (#{names})")

      if val_key == correct_key
        attempts.each do |t|
          points[t.player.name] += 1000
          delayed_respond(event, "**CORRECT!** +1000 points for #{t.player.name}")
        end
        delayed_respond(event, "âœ… The real answer was: **#{real_answers[q_no]}**")
      else
        liar_entry = @solved_fibbs[q_no].find { |h| h[:value].downcase == val_key }
        if liar_entry
          liar_name = liar_entry[:author]
          points[liar_name] += 500
          delayed_respond(event, "âŒ WRONG! It was #{liar_name}'s lie!")
          delayed_respond(event, "#{liar_name} gets +500 points")
        else
          delayed_respond(event, "âŒ Wrong answer â€” but no liar matched for \"#{display_value}\"")
        end
      end
    end

    delayed_respond(event, ".")
    delayed_respond(event, "ğŸ“Š Current Scores:")
    points.sort_by { |_name, score| -score }.each do |name, score|
      delayed_respond(event, "#{name}: #{score}")
    end
  end

  delayed_respond(event, ".")
  delayed_respond(event, "ğŸ† Final Scores:")
  points.sort_by { |_name, score| -score }.each do |name, score|
    delayed_respond(event, "#{name}: #{score}")
  end
end

end